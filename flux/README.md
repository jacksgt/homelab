# Kubernetes Services managed with Flux v2

https://github.com/fluxcd/flux2

Test locally: `kubectl apply -k ./apps/dev/ --dry-run=client -o yaml`

Flux CRDs:

`HelmRepository` /  `GitRepository` -> `HelmChart` (auto-generated by Helm controller) -> `HelmRelease`

https://fluxcd.io/flux/components/helm/

Initialize "prod" environment by pointing Flux to the Git repo and Kustomization: `kubectl apply -f flux-apps-prod.yaml`

Useful commands:

* `flux tree kustomization apps-prod` (`-n flux-system` is implied)

## HelmController

Deploy applications from Helm repositories: https://fluxcd.io/flux/guides/helmreleases/

Helm controller has experimental support for drift-detection: https://github.com/fluxcd/helm-controller/issues/643

The Helm controller sometimes falls into a failed reconciliation state (`upgrade retries exhausted`): https://github.com/fluxcd/helm-controller/issues/454

=> can be worked around with `flux suspend helmrelease` + `flux resume helmrelease`

Use ConfigMaps and Secrets as Helm values input: https://fluxcd.io/flux/guides/helmreleases/#refer-to-values-in-configmap-and-secret-resources

Example repo using Flux + Kustomize to deploy K8s resources and Helm charts: https://github.com/fluxcd/flux2-kustomize-helm-example


## Bootstrapping flux

Get chart version from https://github.com/fluxcd-community/helm-charts/pkgs/container/charts%2Fflux2

```sh
RELEASE=2.10.0
helm upgrade --install -n flux-system -f flux.values.yaml flux oci://ghcr.io/fluxcd-community/charts/flux2 --version $RELEASE
```

## Secrets Management

Using [SOPS](https://github.com/mozilla/sops) and [age](https://age-encryption.org/), following <https://fluxcd.io/flux/guides/mozilla-sops/>.

Create a new public/private keypair:

```sh
age-keygen -o agekey.txt

export PUB_KEY=<public key from previous command>
```

Inject it into the cluster:

```sh
kubectl create secret generic sops-age \
--namespace=flux-system \
--from-file=age.agekey=agekey.txt
```

Remove `age.agekey` from the repository and store it in a secure location!

```sh
mkdir -p ~/.config/sops/age/
mv -n agekey.txt ~/.config/sops/age/keys.txt
```

Add this to the main `Kustomization`:

```yaml
spec:
  decryption:
    provider: sops
    secretRef:
      name: sops-age
```

Create SOPS config:

```
cat <<EOF > .sops.yaml
creation_rules:
  - path_regex: (.*)\.secret\.yaml
    encrypted_regex: ^(data|stringData)$
    age: ${PUB_KEY}
EOF
```

Note: all sensitive information must be stored in files named `*.secret.yaml`.

Give SOPS encryption a try:

```
kubectl -n default create secret generic example \
--from-literal=user=admin \
--from-literal=password=change-me \
--dry-run=client \
-o yaml > example.secret.yaml

sops --encrypt --in-place example.secret.yaml

cat example.secret.yaml

# edit secret file with $EDITOR
sops example.secret.yaml
```

TODO: set up git commit hook to ensure all `*.secret.yaml` files are encrypted

See also: <https://blog.loholt.io/sops/>

## Backup Kubernetes manifests

Store k8s YAML manifests locally with [kube-dump](https://github.com/WoozyMasta/kube-dump):

```
mkdir -p kube_dump
kube-dump all -d kube_dump/
```

The following objects could be excluded, but [it's currently not supported by the tool](https://github.com/WoozyMasta/kube-dump/pull/42):

```
events.events.k8s.io
endpointslices.discovery.k8s.io
pods.metrics.k8s.io
pods
replicasets.apps
orders.acme.cert-manager.io
leases.coordination.k8s.io
```

## Resources

### References

* Flux `GitRepository`: https://fluxcd.io/flux/components/source/gitrepositories/
* Flux `HelmRelease`: https://fluxcd.io/flux/guides/helmreleases/
* Kustomize Patches (*Strategic* & *JSON*): https://kubectl.docs.kubernetes.io/references/kustomize/kustomization/patches/
* JSON Patch Reference: https://jsonpatch.com/
* Kustomize Best Practices: https://www.r-bloggers.com/2021/02/kustomize-best-practices/
* Variable substitution with Flux / Kustomize: https://fluxcd.io/flux/components/kustomize/kustomization/#post-build-variable-substitution ,  https://budimanjojo.com/2021/10/27/variable-substitution-in-flux-gitops/

### Examples

* https://libreddit.de/r/selfhosted/comments/wre8ua/authentiktraefikk8sfluxcd_because_documentation/
* https://github.com/lenaxia/k3s-ops/tree/main
* https://github.com/fluxcd/flux2-kustomize-helm-example
* https://geek-cookbook.funkypenguin.co.nz/kubernetes/deployment/flux/operate/
* https://github.com/onedr0p/flux-cluster-template
* JSON Patch Tricks: https://blog.scottlowe.org/2021/07/07/adding-multiple-items-using-kustomize-json-6902-patches/
* Kustomize Overlay Patches cannot be encrypted with SOPS: https://github.com/fluxcd/kustomize-controller/issues/344
* Using Environment Variables with Kustomize: https://mbuffa.github.io/tips/20210720-kustomize-environment-variables/

### Other homelabs using Flux

* https://github.com/samsonnguyen/homelab-flux/ (see `apps/production/kustomization.yaml`)
* https://github.com/woodjme/homelab-flux
* https://github.com/khuedoan/homelab
